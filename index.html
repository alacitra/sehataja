import React, { useState, useEffect, useRef } from 'react';
import { 
  MessageSquare, 
  User, 
  Home, 
  ChevronRight,
  Bell,
  PlusCircle,
  Heart,
  Wallet,
  CheckCircle2,
  ArrowLeft,
  Send,
  Package,
  ShoppingCart,
  Search,
  Store,
  Settings,
  Calendar,
  X,
  Clock,
  Sparkles,
  QrCode,
  Copy,
  CalendarDays,
  Activity,
  Bot,
  BrainCircuit,
  Stethoscope
} from 'lucide-react';

// Konfigurasi API Gemini
const apiKey = ""; // API Key disediakan oleh runtime

const App = () => {
  const [activeTab, setActiveTab] = useState('home');
  const [selectedDoctor, setSelectedDoctor] = useState(null);
  const [userBalance, setUserBalance] = useState(750000);
  const [cart, setCart] = useState([]);
  const [chatHistories, setChatHistories] = useState({});
  const [inputMessage, setInputMessage] = useState('');
  const [isTyping, setIsTyping] = useState(false);
  
  // State Pembayaran
  const [showPaymentModal, setShowPaymentModal] = useState(false);
  const [paymentTarget, setPaymentTarget] = useState(null); 
  const [selectedPaymentMethod, setSelectedPaymentMethod] = useState('wallet');
  const [deliveryMethod, setDeliveryMethod] = useState('reguler');

  // State Top Up
  const [showTopUpModal, setShowTopUpModal] = useState(false);
  const [topUpAmount, setTopUpAmount] = useState(100000);

  // State Janji Temu
  const [appointments, setAppointments] = useState([]);
  const [showAppointmentModal, setShowAppointmentModal] = useState(false);
  const [selectedDate, setSelectedDate] = useState('');

  // State User
  const [userData] = useState({
    name: "Budi Pratama",
    email: "budi.sehat@email.id",
    membership: "Premium",
    address: "Jl. Melati No. 12, Jakarta Selatan",
    age: 28,
    weight: "70kg"
  });

  // State Modal & Animasi
  const [isPaymentSuccess, setIsPaymentSuccess] = useState(false);
  const [isAiResponding, setIsAiResponding] = useState(false);
  const [isCopying, setIsCopying] = useState(false);
  const [aiAnalysisResult, setAiAnalysisResult] = useState(null);
  const [showAiModal, setShowAiModal] = useState(false);

  const chatEndRef = useRef(null);

  useEffect(() => {
    chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [chatHistories, isTyping, isAiResponding, selectedDoctor]);

  const allDoctors = [
    { id: 1, name: "Dr. Siti Aminah", spec: "Dokter Umum", cat: "Umum", rating: 4.8, experience: "8 thn", price: 35000, img: "https://api.dicebear.com/7.x/avataaars/svg?seed=Siti" },
    { id: 2, name: "Dr. Adrian Hartanto", spec: "Spesialis Jantung", cat: "Jantung", rating: 4.9, experience: "15 thn", price: 120000, img: "https://api.dicebear.com/7.x/avataaars/svg?seed=Adrian" },
    { id: 3, name: "Dr. Budi Santoso", spec: "Spesialis Anak", cat: "Anak", rating: 4.9, experience: "12 thn", price: 50000, img: "https://api.dicebear.com/7.x/avataaars/svg?seed=Budi" },
    { id: 4, name: "Dr. Sarah Wijaya", spec: "Psikolog Klinis", cat: "Mental", rating: 4.7, experience: "7 thn", price: 85000, img: "https://api.dicebear.com/7.x/avataaars/svg?seed=Sarah" },
    { id: 5, name: "Dr. Rian Ghozali", spec: "Spesialis Mata", cat: "Mata", rating: 4.6, experience: "10 thn", price: 65000, img: "https://api.dicebear.com/7.x/avataaars/svg?seed=Rian" },
    { id: 6, name: "Dr. Linda Kusuma", spec: "Spesialis Kulit", cat: "Kulit", rating: 4.8, experience: "6 thn", price: 75000, img: "https://api.dicebear.com/7.x/avataaars/svg?seed=Linda" },
  ];

  const medicineProducts = [
    { id: 101, n: "Paracetamol 500mg", p: 12500, img: "https://images.unsplash.com/photo-1584308666744-24d5c474f2ae?w=200", cat: "Obat Umum" },
    { id: 102, n: "Vitamin C 1000mg", p: 48000, img: "https://images.unsplash.com/photo-1616671285390-d99691653890?w=200", cat: "Suplemen" },
    { id: 103, n: "Amoxicillin Tab", p: 25000, img: "https://images.unsplash.com/photo-1550572017-ed200f545dec?w=200", cat: "Antibiotik" },
    { id: 104, n: "Antasida Cair", p: 18000, img: "https://images.unsplash.com/photo-1587854692152-cbe660dbbb88?w=200", cat: "Obat Lambung" },
    { id: 105, n: "Obat Batuk Sirup", p: 32000, img: "https://images.unsplash.com/photo-1563213126-a4273aed2016?w=200", cat: "Batuk & Flu" },
    { id: 106, n: "Minyak Telon", p: 22000, img: "https://images.unsplash.com/photo-1540555700478-4be289fbecee?w=200", cat: "Kesehatan Anak" },
  ];

  const deliveryPrices = { reguler: 10000, instan: 25000 };

  const callGemini = async (prompt, systemPrompt = "You are a helpful medical assistant.") => {
    let delay = 1000;
    for (let i = 0; i < 5; i++) {
      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] }
          })
        });
        const data = await response.json();
        return data.candidates?.[0]?.content?.parts?.[0]?.text;
      } catch (error) {
        if (i === 4) throw error;
        await new Promise(resolve => setTimeout(resolve, delay));
        delay *= 2;
      }
    }
  };

  const handleCopy = (text) => {
    const el = document.createElement('textarea');
    el.value = text;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
    setIsCopying(true);
    setTimeout(() => setIsCopying(false), 2000);
  };

  const handleProcessPayment = () => {
    const totalCost = paymentTarget.type === 'pharmacy' 
      ? paymentTarget.price + deliveryPrices[deliveryMethod] 
      : paymentTarget.price;

    if (selectedPaymentMethod === 'wallet' && userBalance < totalCost) return;
    
    if (selectedPaymentMethod === 'wallet') {
        setUserBalance(prev => prev - totalCost);
    }
    
    setIsPaymentSuccess(true);
    setTimeout(() => {
      setIsPaymentSuccess(false);
      setShowPaymentModal(false);
      if (paymentTarget.type === 'doctor') {
        setSelectedDoctor(paymentTarget.data);
        setActiveTab('chat');
        if (!chatHistories[paymentTarget.data.id]) {
          setChatHistories(prev => ({...prev, [paymentTarget.data.id]: []}));
        }
      } else {
        setCart([]);
        setActiveTab('home');
      }
    }, 2500);
  };

  const handleTopUp = () => {
    setIsPaymentSuccess(true);
    setTimeout(() => {
      setUserBalance(prev => prev + topUpAmount);
      setIsPaymentSuccess(false);
      setShowTopUpModal(false);
    }, 2000);
  };

  const handleCreateAppointment = (doctor) => {
    if (!selectedDate) return;
    const newAppointment = {
      id: Date.now(),
      doctor: doctor,
      date: selectedDate,
      status: 'Dijadwalkan'
    };
    setAppointments([...appointments, newAppointment]);
    setShowAppointmentModal(false);
    setSelectedDate('');
    setActiveTab('appointments');
  };

  const handleSendMessage = async () => {
    if (!inputMessage.trim() || !selectedDoctor) return;
    
    const userMsg = { 
      id: Date.now(), 
      text: inputMessage, 
      sender: 'user', 
      time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) 
    };
    
    setChatHistories(prev => ({ ...prev, [selectedDoctor.id]: [...(prev[selectedDoctor.id] || []), userMsg] }));
    const currentQuery = inputMessage;
    setInputMessage('');
    setIsAiResponding(true);

    try {
      const systemPrompt = `Anda adalah asisten medis AI untuk aplikasi SehatAja. 
      Berikan respon singkat, ramah, dan informatif kepada pasien bernama ${userData.name}.
      Katakan bahwa Anda adalah AI pendukung dan Dokter ${selectedDoctor.name} akan segera membalas secara personal.
      Berikan 1 saran kesehatan praktis terkait keluhan mereka.`;
      
      const aiText = await callGemini(currentQuery, systemPrompt);

      const aiResponse = {
        id: Date.now() + 1,
        text: `✨ [Asisten AI SehatAja]: ${aiText || 'Mohon maaf, saya sedang sibuk. Tunggu sebentar ya.'}`,
        sender: 'ai',
        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
      };
      
      setChatHistories(prev => ({ ...prev, [selectedDoctor.id]: [...(prev[selectedDoctor.id] || []), aiResponse] }));
    } catch (e) {
      console.error(e);
    } finally {
      setIsAiResponding(false);
    }

    setTimeout(() => {
      setIsTyping(true);
      setTimeout(() => {
        const doctorMsg = {
          id: Date.now() + 2,
          text: `Halo ${userData.name.split(' ')[0]}, saya sudah melihat catatan asisten AI saya. Ada gejala lain yang mengiringi?`,
          sender: 'doctor',
          time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
        };
        setChatHistories(prev => ({ ...prev, [selectedDoctor.id]: [...(prev[selectedDoctor.id] || []), doctorMsg] }));
        setIsTyping(false);
      }, 3000);
    }, 1000);
  };

  const handleAskAiDiagnostic = async () => {
    if (!selectedDoctor) return;
    const history = chatHistories[selectedDoctor.id] || [];
    if (history.length === 0) return;

    setShowAiModal(true);
    setAiAnalysisResult("Sedang menganalisis gejala Anda...");
    setIsAiResponding(true);

    const fullHistory = history.map(h => `${h.sender}: ${h.text}`).join('\n');
    const prompt = `Analisis riwayat percakapan berikut dan berikan ringkasan kemungkinan kondisi (Symptom Checking) serta pertanyaan lanjutan yang harus diajukan pasien kepada dokter.
    Riwayat: ${fullHistory}`;

    try {
      const result = await callGemini(prompt, "Anda adalah sistem pakar medis AI. Berikan analisis dalam bahasa Indonesia yang terstruktur.");
      setAiAnalysisResult(result);
    } catch (e) {
      setAiAnalysisResult("Gagal melakukan analisis. Coba lagi nanti.");
    } finally {
      setIsAiResponding(false);
    }
  };

  // Komponen Reusable untuk QRIS & Transfer Bank
  const UniversalPaymentView = ({ onConfirm }) => {
    const [subMethod, setSubMethod] = useState('qris');
    return (
      <div className="space-y-4 animate-in fade-in duration-300">
        <div className="flex gap-2 p-1 bg-gray-100 rounded-xl">
          <button 
            onClick={() => setSubMethod('qris')} 
            className={`flex-1 py-2 rounded-lg text-[10px] font-black transition-all ${subMethod === 'qris' ? 'bg-white shadow-sm text-red-500' : 'text-gray-400'}`}
          >
            QRIS
          </button>
          <button 
            onClick={() => setSubMethod('bank')} 
            className={`flex-1 py-2 rounded-lg text-[10px] font-black transition-all ${subMethod === 'bank' ? 'bg-white shadow-sm text-red-500' : 'text-gray-400'}`}
          >
            TRANSFER BANK
          </button>
        </div>

        {subMethod === 'qris' ? (
          <div className="flex flex-col items-center p-4 bg-white border border-gray-100 rounded-2xl space-y-3">
             <div className="w-40 h-40 bg-gray-50 rounded-xl flex items-center justify-center relative border p-2">
                <QrCode size={120} className="text-gray-800" />
                <div className="absolute inset-0 flex items-center justify-center bg-white/5 opacity-0 hover:opacity-100 transition-opacity">
                   <span className="text-[8px] font-black bg-black text-white px-2 py-1 rounded">SCAN ME</span>
                </div>
             </div>
             <p className="text-center text-[9px] font-bold text-gray-500">Scan QRIS di atas dengan aplikasi pembayaran Anda.</p>
          </div>
        ) : (
          <div className="space-y-2">
             <div className="p-3 bg-white border border-gray-100 rounded-xl flex items-center justify-between">
                <div className="flex items-center gap-3">
                   <div className="w-8 h-8 bg-blue-50 rounded-lg flex items-center justify-center font-black text-blue-600 text-[9px]">BCA</div>
                   <div>
                      <p className="text-[8px] font-black text-gray-400 uppercase">A.N SEHATAJA MEDIKA</p>
                      <p className="text-xs font-bold">8801 2293 4451</p>
                   </div>
                </div>
                <button onClick={() => handleCopy('880122934451')} className="p-2 text-gray-400 hover:text-red-500 transition-colors">
                  <Copy size={14}/>
                </button>
             </div>
             <div className="p-3 bg-white border border-gray-100 rounded-xl flex items-center justify-between">
                <div className="flex items-center gap-3">
                   <div className="w-8 h-8 bg-orange-50 rounded-lg flex items-center justify-center font-black text-orange-600 text-[9px]">BNI</div>
                   <div>
                      <p className="text-[8px] font-black text-gray-400 uppercase">A.N SEHATAJA MEDIKA</p>
                      <p className="text-xs font-bold">0992 1123 55</p>
                   </div>
                </div>
                <button onClick={() => handleCopy('0992112355')} className="p-2 text-gray-400 hover:text-red-500 transition-colors">
                  <Copy size={14}/>
                </button>
             </div>
          </div>
        )}
        
        <button 
          onClick={onConfirm} 
          className="w-full py-4 bg-red-500 text-white rounded-2xl font-black shadow-lg uppercase text-[10px] tracking-widest active:scale-95 transition-transform"
        >
          SAYA SUDAH BAYAR
        </button>
      </div>
    );
  };

  return (
    <div className="max-w-md mx-auto h-screen bg-white shadow-2xl flex flex-col relative overflow-hidden font-sans text-gray-800">
      
      {isCopying && <div className="fixed top-10 left-1/2 -translate-x-1/2 z-[200] bg-black/80 text-white px-4 py-2 rounded-full text-[10px] font-black">BERHASIL DISALIN</div>}

      {/* MODAL AI DIAGNOSIS */}
      {showAiModal && (
        <div className="fixed inset-0 z-[150] bg-black/60 backdrop-blur-md flex items-center justify-center p-6">
          <div className="bg-white w-full rounded-[32px] p-6 shadow-2xl max-h-[80vh] flex flex-col">
            <div className="flex justify-between items-center mb-4">
              <div className="flex items-center gap-2 text-indigo-600">
                <BrainCircuit size={24} />
                <h2 className="font-black italic">AI <span className="text-gray-900">Diagnosis ✨</span></h2>
              </div>
              <button onClick={() => setShowAiModal(false)} className="p-2 bg-gray-100 rounded-full"><X size={18} /></button>
            </div>
            <div className="flex-1 overflow-y-auto text-xs leading-relaxed text-gray-600 font-medium whitespace-pre-wrap py-2">
              {isAiResponding ? (
                <div className="flex flex-col items-center justify-center h-40 space-y-4">
                   <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                   <p className="animate-pulse font-black text-indigo-500">Menganalisis Gejala Anda...</p>
                </div>
              ) : aiAnalysisResult}
            </div>
            {!isAiResponding && (
              <button onClick={() => setShowAiModal(false)} className="mt-4 w-full py-3 bg-indigo-600 text-white rounded-2xl font-black text-xs shadow-lg">PAHAM</button>
            )}
          </div>
        </div>
      )}

      {/* MODAL TOP UP */}
      {showTopUpModal && (
        <div className="fixed inset-0 z-[110] bg-black/60 backdrop-blur-sm flex items-end justify-center">
          <div className="w-full max-w-md bg-white rounded-t-[40px] p-6 animate-in slide-in-from-bottom duration-300">
            <div className="flex justify-between items-center mb-6">
               <h2 className="text-lg font-black italic">Isi <span className="text-red-500">Saldo</span></h2>
               <button onClick={() => setShowTopUpModal(false)} className="p-2 bg-gray-100 rounded-full"><X size={18} /></button>
            </div>
            {isPaymentSuccess ? (
              <div className="flex flex-col items-center py-10 text-center">
                <div className="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center text-white mb-4 animate-bounce">
                  <CheckCircle2 size={32} />
                </div>
                <h3 className="font-black text-lg">Top Up Berhasil!</h3>
                <p className="text-xs text-gray-400 font-bold mt-1">Saldo Anda telah diperbarui.</p>
              </div>
            ) : (
              <div className="space-y-6">
                <div className="grid grid-cols-2 gap-4">
                  {[50000, 100000, 250000, 500000].map(amt => (
                    <button 
                      key={amt} 
                      onClick={() => setTopUpAmount(amt)} 
                      className={`p-4 rounded-2xl border-2 font-black transition-all ${topUpAmount === amt ? 'border-red-500 bg-red-50 text-red-500' : 'border-gray-100 bg-white'}`}
                    >
                      Rp{amt.toLocaleString()}
                    </button>
                  ))}
                </div>
                <UniversalPaymentView onConfirm={handleTopUp} />
              </div>
            )}
          </div>
        </div>
      )}

      {/* MODAL JANJI TEMU */}
      {showAppointmentModal && (
        <div className="fixed inset-0 z-[110] bg-black/60 backdrop-blur-sm flex items-end justify-center">
          <div className="w-full max-w-md bg-white rounded-t-[40px] p-6 animate-in slide-in-from-bottom duration-300">
            <div className="flex justify-between items-center mb-6">
               <h2 className="text-lg font-black italic">Buat <span className="text-red-500">Janji</span></h2>
               <button onClick={() => setShowAppointmentModal(false)} className="p-2 bg-gray-100 rounded-full"><X size={18} /></button>
            </div>
            <div className="space-y-4">
              <div className="bg-gray-50 p-4 rounded-2xl">
                 <p className="text-[10px] font-black text-gray-400 uppercase mb-2">Pilih Tanggal</p>
                 <input type="date" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} className="w-full bg-white border border-gray-200 p-3 rounded-xl font-bold outline-none" />
              </div>
              <p className="text-[10px] font-black text-gray-400 uppercase px-1">Pilih Dokter</p>
              {allDoctors.slice(0, 3).map(doc => (
                <button key={doc.id} onClick={() => handleCreateAppointment(doc)} className="w-full p-4 bg-white border border-gray-100 rounded-2xl flex items-center gap-4 text-left active:scale-95 transition-transform">
                   <img src={doc.img} className="w-10 h-10 rounded-xl bg-gray-50" />
                   <div className="flex-1"><h4 className="text-xs font-bold">{doc.name}</h4><p className="text-[10px] text-gray-400">{doc.spec}</p></div>
                   <ChevronRight size={16} className="text-gray-300" />
                </button>
              ))}
            </div>
          </div>
        </div>
      )}

      {/* MODAL PEMBAYARAN TRANSAKSI */}
      {showPaymentModal && (
        <div className="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-end justify-center">
          <div className="w-full max-w-md bg-white rounded-t-[40px] p-6 animate-in slide-in-from-bottom duration-300">
            <div className="flex justify-between items-center mb-6">
               <h2 className="text-lg font-black italic">Metode <span className="text-red-500">Bayar</span></h2>
               <button onClick={() => setShowPaymentModal(false)} className="p-2 bg-gray-100 rounded-full"><X size={18} /></button>
            </div>
            {isPaymentSuccess ? (
              <div className="flex flex-col items-center py-10 text-center">
                <div className="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center text-white mb-4 animate-bounce">
                  <CheckCircle2 size={32} />
                </div>
                <h3 className="font-black text-lg">Transaksi Berhasil!</h3>
                <p className="text-xs text-gray-400 font-bold mt-1">Mengalihkan Anda dalam sekejap...</p>
              </div>
            ) : (
              <div className="space-y-6">
                <div className="bg-gray-50 p-4 rounded-2xl border">
                   <div className="flex justify-between text-[10px] font-black mb-2"><span className="text-gray-400 uppercase tracking-widest">Item Layanan</span><span className="text-gray-900">{paymentTarget?.label}</span></div>
                   <div className="flex justify-between text-sm font-black text-red-500 pt-3 border-t border-gray-200"><span>TOTAL TAGIHAN</span><span>Rp{(paymentTarget?.price + (paymentTarget?.type === 'pharmacy' ? deliveryPrices[deliveryMethod] : 0)).toLocaleString()}</span></div>
                </div>
                
                <div className="space-y-3">
                   {/* Opsi Dompet */}
                   <button onClick={() => setSelectedPaymentMethod('wallet')} className={`w-full p-4 rounded-2xl border flex items-center justify-between transition-all ${selectedPaymentMethod === 'wallet' ? 'border-red-500 bg-red-50 ring-1 ring-red-500' : 'border-gray-100'}`}>
                      <div className="flex items-center gap-3">
                        <Wallet size={20} className={selectedPaymentMethod === 'wallet' ? 'text-red-500' : 'text-gray-400'} />
                        <div className="text-left">
                          <p className="text-[10px] font-black text-gray-700">DOMPET SEHATAJA</p>
                          <p className="text-[9px] font-bold text-gray-400">Saldo: Rp{userBalance.toLocaleString()}</p>
                        </div>
                      </div>
                      {selectedPaymentMethod === 'wallet' && <CheckCircle2 size={16} className="text-red-500" />}
                   </button>

                   {/* Opsi QRIS & Bank Lainnya */}
                   <button onClick={() => setSelectedPaymentMethod('other')} className={`w-full p-4 rounded-2xl border flex items-center justify-between transition-all ${selectedPaymentMethod === 'other' ? 'border-red-500 bg-red-50 ring-1 ring-red-500' : 'border-gray-100'}`}>
                      <div className="flex items-center gap-3">
                        <div className="flex -space-x-1">
                          <QrCode size={18} className={selectedPaymentMethod === 'other' ? 'text-red-500' : 'text-gray-400'} />
                          <Settings size={18} className={selectedPaymentMethod === 'other' ? 'text-red-500' : 'text-gray-400'} />
                        </div>
                        <div className="text-left">
                          <p className="text-[10px] font-black text-gray-700 uppercase">QRIS / Transfer Bank</p>
                          <p className="text-[9px] font-bold text-gray-400">Bayar via aplikasi bank atau QR</p>
                        </div>
                      </div>
                      {selectedPaymentMethod === 'other' && <CheckCircle2 size={16} className="text-red-500" />}
                   </button>
                </div>

                {selectedPaymentMethod === 'other' ? (
                   <UniversalPaymentView onConfirm={handleProcessPayment} />
                ) : (
                   <button 
                    onClick={handleProcessPayment} 
                    disabled={userBalance < (paymentTarget?.price || 0)}
                    className={`w-full py-4 rounded-2xl font-black shadow-lg uppercase text-xs transition-all ${userBalance < (paymentTarget?.price || 0) ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-red-500 text-white active:scale-95'}`}
                   >
                     {userBalance < (paymentTarget?.price || 0) ? 'SALDO TIDAK CUKUP' : 'BAYAR DENGAN DOMPET'}
                   </button>
                )}
              </div>
            )}
          </div>
        </div>
      )}

      {/* CONTENT AREA */}
      <div className="flex-1 overflow-y-auto bg-gray-50/30">
        {activeTab === 'home' && (
          <div className="space-y-6 pb-32">
            <div className="bg-white px-5 pt-6 pb-4 flex justify-between items-center sticky top-0 z-30 border-b">
              <div className="flex items-center gap-2">
                <Heart size={22} className="text-red-500" fill="currentColor" />
                <span className="text-xl font-black">Sehat<span className="text-red-500">Aja</span></span>
              </div>
              <div className="flex gap-4">
                <div className="relative cursor-pointer" onClick={() => setActiveTab('pharmacy')}>
                  <ShoppingCart size={22} />
                  {cart.length > 0 && (
                    <span className="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center font-bold">
                      {cart.length}
                    </span>
                  )}
                </div>
                <Bell size={22} />
              </div>
            </div>

            <div className="px-5">
              <div className="bg-white border border-gray-100 rounded-2xl p-4 flex items-center justify-between shadow-sm">
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-blue-50 rounded-xl"><Wallet className="text-blue-500" size={20} /></div>
                  <div><p className="text-[9px] font-black text-gray-400 uppercase tracking-widest">Saldo Anda</p><p className="text-sm font-black">Rp{userBalance.toLocaleString()}</p></div>
                </div>
                <button onClick={() => setShowTopUpModal(true)} className="text-blue-600 font-black text-[10px] bg-blue-50 px-4 py-2 rounded-xl hover:bg-blue-100 transition-colors uppercase">Isi Saldo</button>
              </div>
            </div>

            <div className="px-5 grid grid-cols-4 gap-4">
              {[
                { name: "Chat", icon: <MessageSquare />, color: "bg-pink-50 text-pink-500", action: () => setActiveTab('chat') },
                { name: "Toko", icon: <Package />, color: "bg-blue-50 text-blue-500", action: () => setActiveTab('pharmacy') },
                { name: "Janji", icon: <Calendar />, color: "bg-orange-50 text-orange-500", action: () => setShowAppointmentModal(true) },
                { name: "AI Health ✨", icon: <BrainCircuit />, color: "bg-indigo-50 text-indigo-500", action: () => { setActiveTab('chat'); handleAskAiDiagnostic(); } },
              ].map((s, idx) => (
                <button key={idx} onClick={s.action} className="flex flex-col items-center gap-2 group">
                  <div className={`${s.color} w-full aspect-square rounded-2xl flex items-center justify-center shadow-sm group-active:scale-90 transition-transform`}>{s.icon}</div>
                  <span className="text-[9px] font-black text-gray-700 uppercase">{s.name}</span>
                </button>
              ))}
            </div>

            <div className="px-5 space-y-3">
              <div className="flex justify-between items-center">
                <h2 className="text-sm font-black uppercase tracking-widest">Rekomendasi Dokter</h2>
                <button className="text-[10px] font-black text-red-500">LIHAT SEMUA</button>
              </div>
              {allDoctors.slice(0, 3).map(doc => (
                <div key={doc.id} className="bg-white p-4 rounded-2xl border border-gray-100 flex items-center gap-4 hover:shadow-md transition-shadow">
                  <img src={doc.img} className="w-14 h-14 rounded-xl bg-gray-50 border" />
                  <div className="flex-1"><h3 className="font-bold text-xs">{doc.name}</h3><p className="text-[10px] text-gray-400 font-medium">{doc.spec}</p></div>
                  <button 
                    onClick={() => { setPaymentTarget({ type: 'doctor', price: doc.price, data: doc, label: `Konsultasi: ${doc.name}` }); setShowPaymentModal(true); }} 
                    className="bg-red-50 text-red-500 px-3 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-red-500 hover:text-white transition-colors"
                  >
                    CHAT
                  </button>
                </div>
              ))}
            </div>
          </div>
        )}

        {activeTab === 'pharmacy' && (
          <div className="h-full bg-white flex flex-col pb-32">
            <div className="p-5 border-b sticky top-0 bg-white z-20 flex items-center gap-4">
              <button onClick={() => setActiveTab('home')} className="p-2 bg-gray-50 rounded-xl"><ArrowLeft size={18} /></button>
              <h2 className="text-lg font-black italic">Toko <span className="text-red-500">Sehat</span></h2>
            </div>
            <div className="px-5 py-3">
                <div className="bg-indigo-50 p-3 rounded-2xl border border-indigo-100 flex items-center gap-3">
                    <Sparkles className="text-indigo-600" size={18} />
                    <p className="text-[9px] font-bold text-indigo-700 leading-tight">Gunakan fitur <span className="font-black">AI ✨</span> untuk analisa obat yang tepat bagi profil kesehatan Anda!</p>
                </div>
            </div>
            <div className="p-5 grid grid-cols-2 gap-4">
               {medicineProducts.map((item) => (
                 <div key={item.id} className="bg-white border border-gray-100 rounded-3xl p-3 flex flex-col hover:shadow-lg transition-shadow">
                    <img src={item.img} className="w-full h-24 object-cover rounded-2xl mb-3 shadow-sm" />
                    <h4 className="text-[10px] font-black h-8 line-clamp-2 text-gray-700">{item.n}</h4>
                    <div className="mt-3 flex justify-between items-center">
                       <span className="text-[11px] font-black text-red-500">Rp{item.p.toLocaleString()}</span>
                       <button onClick={() => setCart([...cart, item])} className="p-2 bg-red-50 text-red-500 rounded-xl active:scale-90 transition-transform"><PlusCircle size={16} /></button>
                    </div>
                 </div>
               ))}
            </div>
            {cart.length > 0 && (
              <div className="fixed bottom-24 left-5 right-5 z-40 animate-in slide-in-from-bottom">
                <button onClick={() => { const total = cart.reduce((acc, curr) => acc + curr.p, 0); setPaymentTarget({ type: 'pharmacy', price: total, label: `Beli Obat (${cart.length} item)` }); setShowPaymentModal(true); }} className="w-full bg-red-500 text-white p-4 rounded-[20px] font-black flex justify-between items-center shadow-2xl uppercase text-[11px] tracking-widest border-2 border-white/20">
                   <div className="flex items-center gap-2"><ShoppingCart size={18}/><span>CHECKOUT ({cart.length})</span></div>
                   <span>Rp{cart.reduce((acc, curr) => acc + curr.p, 0).toLocaleString()}</span>
                </button>
              </div>
            )}
          </div>
        )}

        {/* TAB CHAT, JANJI, PROFIL TETAP SAMA NAMUN DENGAN UI YANG KONSISTEN */}
        {activeTab === 'chat' && (
          <div className="h-full flex flex-col bg-white">
            {!selectedDoctor ? (
              <div className="flex flex-col h-full animate-in fade-in">
                <div className="p-5 border-b sticky top-0 bg-white z-20">
                  <h2 className="text-xl font-black mb-4">Chat Dokter</h2>
                  <div className="relative">
                    <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" size={16} />
                    <input type="text" placeholder="Cari dokter aktif..." className="w-full bg-gray-50 p-4 pl-12 rounded-2xl text-[11px] font-bold outline-none border border-transparent focus:border-red-500/20" />
                  </div>
                </div>
                <div className="flex-1 overflow-y-auto divide-y divide-gray-50">
                  {Object.keys(chatHistories).map(docId => {
                    const doctor = allDoctors.find(d => d.id === parseInt(docId));
                    if (!doctor) return null;
                    const messages = chatHistories[docId];
                    const lastMsg = messages[messages.length - 1] || { text: "Chat Baru", time: "" };
                    return (
                      <button key={docId} onClick={() => setSelectedDoctor(doctor)} className="w-full p-5 flex items-center gap-4 active:bg-gray-50 transition-colors">
                        <img src={doctor.img} className="w-12 h-12 rounded-full border shadow-sm" />
                        <div className="flex-1 text-left"><h4 className="font-bold text-xs">{doctor.name}</h4><p className="text-[10px] text-gray-400 truncate">{lastMsg.text}</p></div>
                        <div className="text-[8px] font-black text-gray-300 uppercase">{lastMsg.time}</div>
                      </button>
                    );
                  })}
                </div>
              </div>
            ) : (
              <div className="h-full flex flex-col bg-gray-50">
                <div className="p-4 bg-white border-b flex items-center justify-between sticky top-0 z-20 shadow-sm">
                  <div className="flex items-center gap-3">
                    <button onClick={() => setSelectedDoctor(null)} className="p-2 -ml-2 hover:bg-gray-50 rounded-full"><ArrowLeft size={20} /></button>
                    <img src={selectedDoctor.img} className="w-10 h-10 rounded-full border" />
                    <div><h3 className="font-black text-[11px]">{selectedDoctor.name}</h3><p className="text-[8px] text-green-500 font-black uppercase tracking-widest">● Online</p></div>
                  </div>
                  <button onClick={handleAskAiDiagnostic} className="bg-indigo-600 text-white px-3 py-2 rounded-full text-[9px] font-black flex items-center gap-2 shadow-lg shadow-indigo-100 active:scale-95 transition-all">
                    <Sparkles size={12} /> DIAGNOSIS AI ✨
                  </button>
                </div>
                <div className="flex-1 p-5 overflow-y-auto space-y-4">
                  {(chatHistories[selectedDoctor.id] || []).map((msg, i) => (
                    <div key={i} className={`flex flex-col ${msg.sender === 'user' ? 'items-end' : 'items-start'}`}>
                      <div className={`max-w-[85%] p-4 rounded-[22px] text-[12px] font-medium shadow-sm ${msg.sender === 'user' ? 'bg-red-500 text-white rounded-tr-none' : msg.sender === 'ai' ? 'bg-indigo-600 text-white rounded-tl-none' : 'bg-white text-gray-700 border rounded-tl-none'}`}>
                        {msg.text}
                      </div>
                      <span className="text-[8px] text-gray-300 mt-1 uppercase font-black px-1">{msg.time}</span>
                    </div>
                  ))}
                  {isAiResponding && (
                    <div className="flex items-center gap-3 text-indigo-500 italic text-[10px] font-black animate-pulse px-2">
                        <Bot size={16} /> Asisten AI sedang berpikir...
                    </div>
                  )}
                  {isTyping && <div className="text-[10px] text-gray-400 italic font-medium px-2">Dokter sedang mengetik...</div>}
                  <div ref={chatEndRef} />
                </div>
                <div className="p-4 bg-white border-t flex items-center gap-3 pb-32">
                  <input type="text" placeholder="Ceritakan keluhan Anda..." className="flex-1 bg-gray-50 p-4 rounded-2xl text-[11px] outline-none font-bold border border-transparent focus:border-red-500/20" value={inputMessage} onChange={(e) => setInputMessage(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()} />
                  <button onClick={handleSendMessage} className="p-3 bg-red-500 text-white rounded-xl shadow-lg active:scale-90 transition-transform"><Send size={18} /></button>
                </div>
              </div>
            )}
          </div>
        )}

        {activeTab === 'appointments' && (
           <div className="h-full bg-white flex flex-col pb-32">
              <div className="p-5 border-b flex items-center gap-4 animate-in slide-in-from-top"><button onClick={() => setActiveTab('home')} className="p-2 bg-gray-50 rounded-xl"><ArrowLeft size={18} /></button><h2 className="text-lg font-black italic">Janji <span className="text-red-500">Temu</span></h2></div>
              <div className="p-5 space-y-4">
                 {appointments.map(apt => (
                   <div key={apt.id} className="bg-white border border-gray-100 rounded-3xl p-5 flex items-center gap-4 hover:shadow-md transition-shadow">
                      <div className="bg-orange-50 p-4 rounded-2xl text-orange-500"><CalendarDays size={24} /></div>
                      <div className="flex-1"><h4 className="text-sm font-black">{apt.doctor.name}</h4><p className="text-[10px] text-gray-400 font-black uppercase tracking-widest mt-1">{apt.date}</p></div>
                      <span className="bg-green-50 text-green-600 px-3 py-1.5 rounded-xl text-[9px] font-black uppercase">{apt.status}</span>
                   </div>
                 ))}
                 {appointments.length === 0 && <div className="text-center py-24 text-gray-300 font-black text-[10px] uppercase tracking-[0.2em] border-2 border-dashed rounded-[40px] m-5 bg-gray-50/50">Belum ada janji temu</div>}
              </div>
           </div>
        )}

        {activeTab === 'profile' && (
          <div className="bg-white h-full flex flex-col items-center pt-16 px-8">
             <div className="relative mb-6">
                <div className="w-28 h-28 rounded-full bg-indigo-50 flex items-center justify-center p-1 border-4 border-white shadow-xl">
                  <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Budi" className="w-full h-full rounded-full" />
                </div>
                <div className="absolute bottom-0 right-0 bg-indigo-600 text-white p-2 rounded-full border-4 border-white shadow-lg"><Sparkles size={16} /></div>
             </div>
             <h2 className="text-xl font-black">{userData.name}</h2>
             <p className="text-[10px] font-black text-indigo-600 mb-8 uppercase tracking-[0.2em] bg-indigo-50 px-4 py-1.5 rounded-full">Premium Member ✨</p>
             
             <div className="w-full space-y-4">
                <div className="grid grid-cols-2 gap-4 mb-4">
                   <div className="bg-gray-50 p-4 rounded-3xl text-center"><p className="text-[9px] font-black text-gray-400 uppercase">Umur</p><p className="font-black text-sm">{userData.age} Thn</p></div>
                   <div className="bg-gray-50 p-4 rounded-3xl text-center"><p className="text-[9px] font-black text-gray-400 uppercase">Berat</p><p className="font-black text-sm">{userData.weight}</p></div>
                </div>
                <button onClick={() => setActiveTab('appointments')} className="w-full p-5 bg-white rounded-3xl flex items-center justify-between font-black text-xs border border-gray-100 hover:bg-gray-50 transition-colors shadow-sm">
                   <div className="flex items-center gap-4"><Calendar size={18} className="text-red-500" /><span>Riwayat Konsultasi</span></div>
                   <ChevronRight size={18} className="text-gray-300"/>
                </button>
                <button className="w-full p-5 bg-red-50 text-red-500 font-black rounded-3xl border border-red-100 hover:bg-red-100 transition-colors uppercase text-[10px] tracking-widest mt-4">Keluaran Akun</button>
             </div>
          </div>
        )}
      </div>

      {/* NAVBAR */}
      <div className="absolute bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t flex justify-around items-center py-5 z-40">
        {[
          { id: 'home', icon: <Home size={22} />, label: 'Home' },
          { id: 'pharmacy', icon: <Store size={22} />, label: 'Toko' },
          { id: 'chat', icon: <MessageSquare size={22} />, label: 'Chat' },
          { id: 'profile', icon: <User size={22} />, label: 'Profil' }
        ].map((tab) => (
          <button 
            key={tab.id} 
            onClick={() => {setActiveTab(tab.id); if(tab.id!=='chat') setSelectedDoctor(null);}} 
            className={`flex flex-col items-center gap-1.5 transition-all ${activeTab === tab.id ? 'text-red-500 scale-110' : 'text-gray-300'}`}
          >
            {tab.icon}
            <span className="text-[9px] font-black uppercase tracking-tighter">{tab.label}</span>
          </button>
        ))}
      </div>
    </div>
  );
};

export default App;
